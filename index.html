<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Á•ûÁµåË°∞Âº± - Memory Card Game</title>
<style>
/* ===== Reset & Base ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
  background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}
.screen { display: none; min-height: 100vh; padding: 20px; }
.screen.active { display: flex; flex-direction: column; align-items: center; }

/* ===== Common UI ===== */
.btn {
  border: none; border-radius: 12px; padding: 14px 32px; font-size: 18px;
  font-weight: 700; cursor: pointer; transition: all 0.2s; color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
.btn:active { transform: translateY(0); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; filter: none; }
.btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
.btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); }
.btn-warning { background: linear-gradient(135deg, #f7971e, #ffd200); color: #333; }
.btn-danger { background: linear-gradient(135deg, #e44d26, #f09819); }
.btn-info { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.btn-sm { padding: 10px 20px; font-size: 14px; }
.points-display {
  background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 24px;
  font-size: 20px; font-weight: 700; backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.15);
}
.points-display .pts { color: #ffd700; }
h1 { font-size: 2.2em; margin-bottom: 10px; }
h2 { font-size: 1.6em; margin-bottom: 10px; }

/* ===== Start Screen ===== */
#start-screen { justify-content: center; gap: 20px; text-align: center; }
#start-screen h1 { font-size: 3em; background: linear-gradient(135deg, #ffd700, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.difficulty-buttons { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; margin: 10px 0; }
.difficulty-buttons .btn { min-width: 140px; }
.sub-buttons { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
.best-scores { margin-top: 10px; font-size: 14px; opacity: 0.8; }
.best-scores div { margin: 4px 0; }

/* ===== Game Screen ===== */
#game-screen { justify-content: flex-start; gap: 12px; }
.game-header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
.game-info { display: flex; gap: 16px; font-size: 16px; font-weight: 600; }
.timer-bar-container { width: 100%; max-width: 600px; height: 12px; background: rgba(255,255,255,0.15); border-radius: 6px; overflow: hidden; }
.timer-bar { height: 100%; background: linear-gradient(90deg, #38ef7d, #11998e); border-radius: 6px; transition: width 0.3s linear; }
.timer-bar.warning { background: linear-gradient(90deg, #f7971e, #ffd200); }
.timer-bar.danger { background: linear-gradient(90deg, #e44d26, #ff4444); animation: pulse-bar 0.5s infinite alternate; }
@keyframes pulse-bar { to { opacity: 0.6; } }
.card-grid {
  display: grid; gap: 8px; justify-content: center; padding: 10px;
  max-width: 600px; width: 100%;
}
.card-grid.grid-4x2 { grid-template-columns: repeat(4, 1fr); }
.card-grid.grid-4x4 { grid-template-columns: repeat(4, 1fr); }
.card-grid.grid-6x6 { grid-template-columns: repeat(6, 1fr); }
.card-cell { aspect-ratio: 1; perspective: 600px; }
.card {
  width: 100%; height: 100%; position: relative; cursor: pointer;
  transform-style: preserve-3d; transition: transform 0.5s;
}
.card.flipped { transform: rotateY(180deg); }
.card.matched { transform: rotateY(180deg); }
.card.matched .card-front { box-shadow: 0 0 20px rgba(56,239,125,0.6); border-color: #38ef7d; }
.card-face {
  position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
  border-radius: 12px; display: flex; align-items: center; justify-content: center;
  font-size: min(8vw, 48px); border: 3px solid rgba(255,255,255,0.2);
}
.card-back {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: rgba(255,255,255,0.6); font-size: min(6vw, 36px); font-weight: 700;
}
.card-back::after {
  content: '?'; position: absolute; font-size: inherit;
}
.card-front {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  transform: rotateY(180deg);
}

/* ===== Result Screens ===== */
#clear-screen, #gameover-screen { justify-content: center; gap: 20px; text-align: center; }
.result-title { font-size: 2.5em; font-weight: 800; }
.result-title.clear { color: #38ef7d; }
.result-title.gameover { color: #e44d26; }
.result-details { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 24px 32px; min-width: 280px; }
.result-details .row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 18px; }
.result-details .row .label { opacity: 0.8; }
.result-details .row .value { font-weight: 700; }
.result-details .total { border-top: 2px solid rgba(255,255,255,0.2); margin-top: 8px; padding-top: 12px; font-size: 22px; }
.result-details .total .value { color: #ffd700; }
.result-buttons { display: flex; gap: 16px; }

/* ===== Gacha Screen ===== */
#gacha-screen { justify-content: center; gap: 20px; text-align: center; }
.gacha-stage { width: 280px; height: 280px; position: relative; display: flex; align-items: center; justify-content: center; }
.capsule {
  width: 120px; height: 150px; position: relative; transition: transform 0.3s;
}
.capsule-top {
  width: 120px; height: 75px; background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  border-radius: 60px 60px 0 0; position: absolute; top: 0;
  transition: transform 0.5s; transform-origin: bottom center;
}
.capsule-bottom {
  width: 120px; height: 75px; background: linear-gradient(135deg, #ddd, #fff);
  border-radius: 0 0 60px 60px; position: absolute; bottom: 0;
}
.capsule-line {
  width: 120px; height: 6px; background: rgba(0,0,0,0.15);
  position: absolute; top: 72px;
}
.gacha-stage.spinning .capsule { animation: capsule-spin 0.8s ease-in-out; }
@keyframes capsule-spin {
  0% { transform: rotate(0deg) scale(1); }
  25% { transform: rotate(-15deg) scale(1.05); }
  50% { transform: rotate(15deg) scale(1.1); }
  75% { transform: rotate(-10deg) scale(1.05); }
  100% { transform: rotate(0deg) scale(1); }
}
.gacha-stage.opening .capsule-top { transform: translateY(-50px) rotate(-30deg); opacity: 0; }
.gacha-result { display: none; text-align: center; }
.gacha-result.show { display: block; }
.gacha-result .new-badge { color: #ff6b6b; font-size: 24px; font-weight: 800; animation: bounce-in 0.5s; }
.gacha-result .dup-badge { color: #aaa; font-size: 18px; }
@keyframes bounce-in {
  0% { transform: scale(0); } 50% { transform: scale(1.3); } 100% { transform: scale(1); }
}
.gacha-buttons { display: flex; gap: 12px; }
/* Gacha flash effects */
.gacha-flash { display: none; position: fixed; inset: 0; z-index: 100; pointer-events: none; }
.gacha-flash.rare-flash { background: radial-gradient(circle, rgba(192,192,255,0.5), transparent 70%); animation: flash-anim 0.6s ease-out forwards; }
.gacha-flash.sr-flash { background: radial-gradient(circle, rgba(255,215,0,0.6), transparent 70%); animation: flash-anim-sr 1s ease-out forwards; }
.gacha-flash.show { display: block; }
@keyframes flash-anim { 0% { opacity: 1; } 100% { opacity: 0; } }
@keyframes flash-anim-sr { 0% { opacity: 1; } 30% { opacity: 0.8; } 60% { opacity: 1; } 100% { opacity: 0; } }

/* ===== Medal ===== */
.medal-display {
  width: 120px; height: 120px; border-radius: 50%; position: relative;
  display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;
  overflow: hidden;
}
.medal-display.rarity-normal { border: 4px solid #cd7f32; }
.medal-display.rarity-rare { border: 4px solid #c0c0c0; box-shadow: 0 0 15px rgba(192,192,192,0.5); }
.medal-display.rarity-sr { border: 4px solid #ffd700; box-shadow: 0 0 25px rgba(255,215,0,0.6); animation: sr-glow 1.5s infinite alternate; }
@keyframes sr-glow { 0% { box-shadow: 0 0 15px rgba(255,215,0,0.4); } 100% { box-shadow: 0 0 35px rgba(255,215,0,0.8); } }
.medal-pattern {
  width: 100%; height: 100%; position: absolute; inset: 0;
}
.medal-name { font-size: 14px; font-weight: 600; margin-top: 4px; }
.medal-rarity-label { font-size: 12px; font-weight: 700; margin-top: 2px; }
.medal-rarity-label.normal { color: #cd7f32; }
.medal-rarity-label.rare { color: #c0c0c0; }
.medal-rarity-label.sr { color: #ffd700; }

/* ===== Collection Screen ===== */
#collection-screen { justify-content: flex-start; gap: 16px; }
.collection-header { text-align: center; }
.collection-progress { font-size: 20px; font-weight: 700; margin: 4px 0; }
.collection-filters { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.filter-btn {
  padding: 8px 16px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.3);
  background: transparent; color: #fff; cursor: pointer; font-size: 14px; font-weight: 600;
  transition: all 0.2s;
}
.filter-btn.active { background: rgba(255,255,255,0.2); border-color: #fff; }
.collection-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 12px; width: 100%; max-width: 700px; padding: 10px;
}
.collection-item {
  aspect-ratio: 1; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; cursor: pointer; position: relative; overflow: hidden;
  transition: transform 0.2s;
}
.collection-item:hover { transform: scale(1.1); }
.collection-item.locked { filter: brightness(0.2) grayscale(1); cursor: default; }
.collection-item.locked:hover { transform: none; }
.collection-item.rarity-normal { border: 3px solid #cd7f32; }
.collection-item.rarity-rare { border: 3px solid #c0c0c0; }
.collection-item.rarity-sr { border: 3px solid #ffd700; }
.collection-item .medal-pattern { width: 100%; height: 100%; }

/* Medal detail modal */
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 200; align-items: center; justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal-content {
  background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px;
  padding: 32px; text-align: center; max-width: 320px; width: 90%;
  border: 1px solid rgba(255,255,255,0.15);
}
.modal-content .medal-display { width: 160px; height: 160px; }
.modal-close { margin-top: 16px; }

/* ===== Medal Patterns (CSS Art) ===== */
/* Colors: 0-9 mapped in JS, Patterns: 0-9 mapped in JS */

/* ===== Responsive ===== */
@media (max-width: 480px) {
  h1 { font-size: 1.8em; }
  .btn { padding: 12px 24px; font-size: 16px; }
  .card-grid { gap: 5px; }
  .card-face { border-radius: 8px; border-width: 2px; }
  .collection-grid { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
  .medal-display { width: 100px; height: 100px; }
  .gacha-stage { width: 220px; height: 220px; }
  .capsule { width: 100px; height: 125px; }
  .capsule-top, .capsule-bottom { width: 100px; height: 62px; }
  .capsule-top { border-radius: 50px 50px 0 0; }
  .capsule-bottom { border-radius: 0 0 50px 50px; }
  .capsule-line { width: 100px; top: 60px; }
  .result-details { padding: 16px 20px; min-width: auto; width: 90%; }
}
@media (max-width: 360px) {
  .card-grid.grid-6x6 { gap: 3px; }
  .card-face { font-size: min(6vw, 28px); }
}
</style>
</head>
<body>

<!-- ===== Start Screen ===== -->
<div id="start-screen" class="screen active">
  <h1>Á•ûÁµåË°∞Âº±</h1>
  <p style="font-size:18px; opacity:0.8; margin-bottom:8px;">Memory Card Game</p>
  <div class="points-display">„Éù„Ç§„É≥„Éà: <span class="pts" id="start-points">0</span></div>
  <h2 style="margin-top:16px;">Èõ£ÊòìÂ∫¶„ÇíÈÅ∏Êäû</h2>
  <div class="difficulty-buttons">
    <button class="btn btn-success" onclick="startGame('easy')">Easy<br><small>4√ó2 / 60Áßí</small></button>
    <button class="btn btn-primary" onclick="startGame('normal')">Normal<br><small>4√ó4 / 90Áßí</small></button>
    <button class="btn btn-danger" onclick="startGame('hard')">Hard<br><small>6√ó6 / 180Áßí</small></button>
  </div>
  <div class="sub-buttons">
    <button class="btn btn-warning" onclick="showScreen('gacha')">„É°„ÉÄ„É´„Ç¨„ÉÅ„É£<br><small>1000pt</small></button>
    <button class="btn btn-info" onclick="showScreen('collection')">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</button>
  </div>
  <div class="best-scores" id="best-scores"></div>
</div>

<!-- ===== Game Screen ===== -->
<div id="game-screen" class="screen">
  <div class="game-header">
    <div class="game-info">
      <span>‚è± <span id="timer-text">60</span>Áßí</span>
      <span>ÊâãÊï∞: <span id="moves-text">0</span></span>
    </div>
    <button class="btn btn-sm btn-danger" onclick="confirmQuit()">„ÇÑ„ÇÅ„Çã</button>
  </div>
  <div class="timer-bar-container">
    <div class="timer-bar" id="timer-bar"></div>
  </div>
  <div class="card-grid" id="card-grid"></div>
</div>

<!-- ===== Clear Screen ===== -->
<div id="clear-screen" class="screen">
  <div class="result-title clear">CLEAR!</div>
  <div class="result-details">
    <div class="row"><span class="label">Èõ£ÊòìÂ∫¶</span><span class="value" id="clear-diff"></span></div>
    <div class="row"><span class="label">ÊâãÊï∞</span><span class="value" id="clear-moves"></span></div>
    <div class="row"><span class="label">ÊÆã„ÇäÊôÇÈñì</span><span class="value" id="clear-time"></span></div>
    <div class="row"><span class="label">Âü∫Êú¨„Éù„Ç§„É≥„Éà</span><span class="value">100</span></div>
    <div class="row"><span class="label">ÊÆã„ÇäÊôÇÈñì„Éú„Éº„Éä„Çπ</span><span class="value" id="clear-time-bonus"></span></div>
    <div class="row"><span class="label">Èõ£ÊòìÂ∫¶ÂÄçÁéá</span><span class="value" id="clear-multiplier"></span></div>
    <div class="row total"><span class="label">Áç≤Âæó„Éù„Ç§„É≥„Éà</span><span class="value" id="clear-total-pts"></span></div>
  </div>
  <div class="points-display">Á¥ØË®à: <span class="pts" id="clear-cumulative"></span></div>
  <div class="result-buttons">
    <button class="btn btn-primary" onclick="replayGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
    <button class="btn btn-info" onclick="showScreen('start')">„Éõ„Éº„É†</button>
  </div>
</div>

<!-- ===== Game Over Screen ===== -->
<div id="gameover-screen" class="screen">
  <div class="result-title gameover">TIME UP</div>
  <p style="font-size:20px; margin:10px 0;">Âà∂ÈôêÊôÇÈñì„ÇíË∂Ö„Åà„Åæ„Åó„Åü</p>
  <div class="result-details">
    <div class="row"><span class="label">Èõ£ÊòìÂ∫¶</span><span class="value" id="go-diff"></span></div>
    <div class="row"><span class="label">ÊâãÊï∞</span><span class="value" id="go-moves"></span></div>
    <div class="row"><span class="label">ÊèÉ„Åà„Åü„Éö„Ç¢</span><span class="value" id="go-pairs"></span></div>
    <div class="row total"><span class="label">Áç≤Âæó„Éù„Ç§„É≥„Éà</span><span class="value">0</span></div>
  </div>
  <div class="result-buttons">
    <button class="btn btn-primary" onclick="replayGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
    <button class="btn btn-info" onclick="showScreen('start')">„Éõ„Éº„É†</button>
  </div>
</div>

<!-- ===== Gacha Screen ===== -->
<div id="gacha-screen" class="screen">
  <h2>„É°„ÉÄ„É´„Ç¨„ÉÅ„É£</h2>
  <div class="points-display">„Éù„Ç§„É≥„Éà: <span class="pts" id="gacha-points">0</span></div>
  <div class="gacha-stage" id="gacha-stage">
    <div class="capsule" id="capsule">
      <div class="capsule-top" id="capsule-top"></div>
      <div class="capsule-line"></div>
      <div class="capsule-bottom"></div>
    </div>
  </div>
  <div class="gacha-result" id="gacha-result">
    <div id="gacha-medal-display"></div>
    <div id="gacha-medal-name" class="medal-name" style="font-size:18px;"></div>
    <div id="gacha-medal-rarity" class="medal-rarity-label" style="font-size:16px;"></div>
    <div id="gacha-badge"></div>
  </div>
  <div class="gacha-buttons">
    <button class="btn btn-warning" id="gacha-btn" onclick="pullGacha()">„Ç¨„ÉÅ„É£„ÇíÂºï„Åè<br><small>1000pt</small></button>
    <button class="btn btn-info" onclick="showScreen('start')">Êàª„Çã</button>
  </div>
</div>
<div class="gacha-flash" id="gacha-flash"></div>

<!-- ===== Collection Screen ===== -->
<div id="collection-screen" class="screen">
  <div class="collection-header">
    <h2>„É°„ÉÄ„É´„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</h2>
    <div class="collection-progress" id="collection-progress">0 / 100</div>
  </div>
  <div class="collection-filters">
    <button class="filter-btn active" data-filter="all" onclick="filterCollection('all', this)">„Åô„Åπ„Å¶</button>
    <button class="filter-btn" data-filter="normal" onclick="filterCollection('normal', this)">Normal</button>
    <button class="filter-btn" data-filter="rare" onclick="filterCollection('rare', this)">Rare</button>
    <button class="filter-btn" data-filter="sr" onclick="filterCollection('sr', this)">SR</button>
  </div>
  <div class="collection-grid" id="collection-grid"></div>
  <button class="btn btn-info" onclick="showScreen('start')" style="margin-top:12px;">Êàª„Çã</button>
</div>

<!-- ===== Medal Detail Modal ===== -->
<div class="modal-overlay" id="medal-modal" onclick="closeMedalModal(event)">
  <div class="modal-content">
    <div id="modal-medal-display"></div>
    <div id="modal-medal-name" class="medal-name" style="font-size:22px; margin-top:12px;"></div>
    <div id="modal-medal-rarity" class="medal-rarity-label" style="font-size:16px;"></div>
    <div id="modal-medal-id" style="font-size:12px; opacity:0.5; margin-top:8px;"></div>
    <button class="btn btn-sm btn-info modal-close" onclick="closeMedalModal()">Èñâ„Åò„Çã</button>
  </div>
</div>

<script>
/* ================================================================
   STATE & CONFIG
   ================================================================ */
const EMOJIS = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶'];

const DIFFICULTY = {
  easy:   { pairs: 4,  cols: 4, rows: 2, time: 60,  mult: 1, label: 'Easy' },
  normal: { pairs: 8,  cols: 4, rows: 4, time: 90,  mult: 2, label: 'Normal' },
  hard:   { pairs: 18, cols: 6, rows: 6, time: 180, mult: 3, label: 'Hard' }
};

const MEDAL_COLORS = [
  '#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c',
  '#3498db','#9b59b6','#e84393','#fd79a8','#636e72'
];

const MEDAL_PATTERN_NAMES = [
  'ÊîæÂ∞Ñ','ÂêåÂøÉÂÜÜ','„Çπ„Éà„É©„Ç§„Éó','„Éâ„ÉÉ„Éà','„ÉÅ„Çß„ÉÉ„ÇØ',
  'Ê≥¢','Ëè±ÂΩ¢','ÊòüÂΩ¢','Ê∏¶Â∑ª„Åç','Ê†ºÂ≠ê'
];

let state = {
  points: 0,
  bestScores: { easy: 0, normal: 0, hard: 0 },
  medals: [] // array of medal IDs (0-99)
};

let game = {
  difficulty: null,
  cards: [],
  flipped: [],
  matched: 0,
  moves: 0,
  totalPairs: 0,
  timeLeft: 0,
  totalTime: 0,
  timerId: null,
  locked: false
};

let gachaAnimating = false;
let currentFilter = 'all';
let lastDifficulty = 'normal';

/* ================================================================
   PERSISTENCE
   ================================================================ */
function loadState() {
  try {
    const d = JSON.parse(localStorage.getItem('memory_game_state'));
    if (d) {
      state.points = d.points || 0;
      state.bestScores = Object.assign({ easy:0, normal:0, hard:0 }, d.bestScores || {});
      state.medals = d.medals || [];
    }
  } catch(e) {}
}

function saveState() {
  localStorage.setItem('memory_game_state', JSON.stringify(state));
}

/* ================================================================
   SCREEN NAVIGATION
   ================================================================ */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id + '-screen').classList.add('active');
  if (id === 'start') refreshStart();
  if (id === 'gacha') refreshGacha();
  if (id === 'collection') refreshCollection();
}

function refreshStart() {
  document.getElementById('start-points').textContent = state.points;
  const bs = document.getElementById('best-scores');
  let html = '<strong>„Éô„Çπ„Éà„Çπ„Ç≥„Ç¢</strong>';
  for (const key of ['easy','normal','hard']) {
    const s = state.bestScores[key];
    html += `<div>${DIFFICULTY[key].label}: ${s > 0 ? s + 'pt' : '---'}</div>`;
  }
  bs.innerHTML = html;
}

/* ================================================================
   GAME LOGIC
   ================================================================ */
function startGame(diff) {
  const cfg = DIFFICULTY[diff];
  lastDifficulty = diff;
  game.difficulty = diff;
  game.totalPairs = cfg.pairs;
  game.matched = 0;
  game.moves = 0;
  game.timeLeft = cfg.time;
  game.totalTime = cfg.time;
  game.flipped = [];
  game.locked = false;

  // Pick emojis and create pairs
  const picked = shuffle([...EMOJIS]).slice(0, cfg.pairs);
  game.cards = shuffle([...picked, ...picked]);

  buildGrid(cfg);
  updateGameUI();
  showScreen('game');
  startTimer();
}

function buildGrid(cfg) {
  const grid = document.getElementById('card-grid');
  grid.className = 'card-grid grid-' + cfg.cols + 'x' + cfg.rows;
  grid.innerHTML = '';
  game.cards.forEach((emoji, i) => {
    const cell = document.createElement('div');
    cell.className = 'card-cell';
    cell.innerHTML = `
      <div class="card" data-index="${i}" onclick="flipCard(this)">
        <div class="card-face card-back"></div>
        <div class="card-face card-front">${emoji}</div>
      </div>`;
    grid.appendChild(cell);
  });
}

function flipCard(el) {
  const idx = parseInt(el.dataset.index);
  if (game.locked) return;
  if (el.classList.contains('flipped') || el.classList.contains('matched')) return;
  if (game.flipped.length >= 2) return;

  el.classList.add('flipped');
  game.flipped.push(el);

  if (game.flipped.length === 2) {
    game.moves++;
    document.getElementById('moves-text').textContent = game.moves;
    const [a, b] = game.flipped;
    const iA = parseInt(a.dataset.index);
    const iB = parseInt(b.dataset.index);

    if (game.cards[iA] === game.cards[iB]) {
      a.classList.add('matched');
      b.classList.add('matched');
      game.matched++;
      game.flipped = [];
      if (game.matched === game.totalPairs) {
        clearInterval(game.timerId);
        setTimeout(showClear, 400);
      }
    } else {
      game.locked = true;
      setTimeout(() => {
        a.classList.remove('flipped');
        b.classList.remove('flipped');
        game.flipped = [];
        game.locked = false;
      }, 900);
    }
  }
}

function startTimer() {
  clearInterval(game.timerId);
  game.timerId = setInterval(() => {
    game.timeLeft--;
    updateGameUI();
    if (game.timeLeft <= 0) {
      clearInterval(game.timerId);
      showGameOver();
    }
  }, 1000);
}

function updateGameUI() {
  document.getElementById('timer-text').textContent = game.timeLeft;
  document.getElementById('moves-text').textContent = game.moves;
  const pct = (game.timeLeft / game.totalTime) * 100;
  const bar = document.getElementById('timer-bar');
  bar.style.width = pct + '%';
  bar.classList.remove('warning','danger');
  if (game.timeLeft <= 10) bar.classList.add('danger');
  else if (pct <= 30) bar.classList.add('warning');
}

function showClear() {
  const cfg = DIFFICULTY[game.difficulty];
  const timeBonus = game.timeLeft;
  const pts = (100 + timeBonus) * cfg.mult;
  state.points += pts;
  if (pts > state.bestScores[game.difficulty]) state.bestScores[game.difficulty] = pts;
  saveState();

  document.getElementById('clear-diff').textContent = cfg.label;
  document.getElementById('clear-moves').textContent = game.moves;
  document.getElementById('clear-time').textContent = timeBonus + 'Áßí';
  document.getElementById('clear-time-bonus').textContent = '+' + timeBonus;
  document.getElementById('clear-multiplier').textContent = '√ó' + cfg.mult;
  document.getElementById('clear-total-pts').textContent = pts + 'pt';
  document.getElementById('clear-cumulative').textContent = state.points;
  showScreen('clear');
}

function showGameOver() {
  const cfg = DIFFICULTY[game.difficulty];
  document.getElementById('go-diff').textContent = cfg.label;
  document.getElementById('go-moves').textContent = game.moves;
  document.getElementById('go-pairs').textContent = game.matched + ' / ' + game.totalPairs;
  showScreen('gameover');
}

function replayGame() { startGame(lastDifficulty); }

function confirmQuit() {
  if (confirm('„Ç≤„Éº„É†„Çí„ÇÑ„ÇÅ„Åæ„Åô„ÅãÔºü')) {
    clearInterval(game.timerId);
    showScreen('start');
  }
}

/* ================================================================
   SHUFFLE (Fisher-Yates)
   ================================================================ */
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* ================================================================
   MEDAL DATA (100 medals: 10 colors √ó 10 patterns)
   ================================================================ */
const ALL_MEDALS = [];
(function generateMedals() {
  let id = 0;
  for (let c = 0; c < 10; c++) {
    for (let p = 0; p < 10; p++) {
      let rarity, rarityLabel;
      // First 60 = Normal, next 30 = Rare, last 10 = SR
      if (id < 60) { rarity = 'normal'; rarityLabel = 'Normal'; }
      else if (id < 90) { rarity = 'rare'; rarityLabel = 'Rare'; }
      else { rarity = 'sr'; rarityLabel = 'SR'; }
      ALL_MEDALS.push({
        id, colorIdx: c, patternIdx: p, rarity, rarityLabel,
        name: MEDAL_COLORS[c].toUpperCase().slice(1) + '-' + MEDAL_PATTERN_NAMES[p],
        color: MEDAL_COLORS[c]
      });
      id++;
    }
  }
})();

/* ================================================================
   MEDAL CSS-ART RENDERING
   ================================================================ */
function renderMedalCSS(medal, size) {
  size = size || 120;
  const c = medal.color;
  const c2 = lighten(c, 40);
  const patterns = [
    /* 0: ÊîæÂ∞Ñ */
    `background: conic-gradient(${c} 0deg, ${c2} 30deg, ${c} 60deg, ${c2} 90deg, ${c} 120deg, ${c2} 150deg, ${c} 180deg, ${c2} 210deg, ${c} 240deg, ${c2} 270deg, ${c} 300deg, ${c2} 330deg, ${c} 360deg);`,
    /* 1: ÂêåÂøÉÂÜÜ */
    `background: repeating-radial-gradient(circle at center, ${c} 0px, ${c} ${size*0.08}px, ${c2} ${size*0.08}px, ${c2} ${size*0.16}px);`,
    /* 2: „Çπ„Éà„É©„Ç§„Éó */
    `background: repeating-linear-gradient(45deg, ${c} 0px, ${c} ${size*0.1}px, ${c2} ${size*0.1}px, ${c2} ${size*0.2}px);`,
    /* 3: „Éâ„ÉÉ„Éà */
    `background: ${c}; background-image: radial-gradient(${c2} ${size*0.1}px, transparent ${size*0.1}px); background-size: ${size*0.25}px ${size*0.25}px;`,
    /* 4: „ÉÅ„Çß„ÉÉ„ÇØ */
    `background-color: ${c}; background-image: linear-gradient(45deg, ${c2} 25%, transparent 25%, transparent 75%, ${c2} 75%), linear-gradient(45deg, ${c2} 25%, transparent 25%, transparent 75%, ${c2} 75%); background-size: ${size*0.25}px ${size*0.25}px; background-position: 0 0, ${size*0.125}px ${size*0.125}px;`,
    /* 5: Ê≥¢ */
    `background: ${c}; background-image: repeating-linear-gradient(0deg, transparent, transparent ${size*0.1}px, ${c2} ${size*0.1}px, ${c2} ${size*0.12}px), repeating-linear-gradient(90deg, transparent, transparent ${size*0.2}px, ${c2} ${size*0.2}px, ${c2} ${size*0.22}px);`,
    /* 6: Ëè±ÂΩ¢ */
    `background: ${c}; background-image: linear-gradient(45deg, ${c2} 25%, transparent 25%), linear-gradient(-45deg, ${c2} 25%, transparent 25%), linear-gradient(135deg, ${c2} 25%, transparent 25%), linear-gradient(-135deg, ${c2} 25%, transparent 25%); background-size: ${size*0.25}px ${size*0.25}px; background-position: 0 0, 0 ${size*0.125}px, ${size*0.125}px -${size*0.125}px, -${size*0.125}px 0;`,
    /* 7: ÊòüÂΩ¢ */
    `background: conic-gradient(from 0deg at 50% 50%, ${c} 0deg, ${c2} 36deg, ${c} 72deg, ${c2} 108deg, ${c} 144deg, ${c2} 180deg, ${c} 216deg, ${c2} 252deg, ${c} 288deg, ${c2} 324deg, ${c} 360deg);`,
    /* 8: Ê∏¶Â∑ª„Åç */
    `background: repeating-conic-gradient(from 0deg, ${c} 0deg 10deg, ${c2} 10deg 20deg);`,
    /* 9: Ê†ºÂ≠ê */
    `background: ${c}; background-image: linear-gradient(${c2} ${size*0.04}px, transparent ${size*0.04}px), linear-gradient(90deg, ${c2} ${size*0.04}px, transparent ${size*0.04}px); background-size: ${size*0.2}px ${size*0.2}px;`
  ];
  return patterns[medal.patternIdx] || patterns[0];
}

function lighten(hex, amt) {
  let r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  r = Math.min(255, r + amt); g = Math.min(255, g + amt); b = Math.min(255, b + amt);
  return '#' + [r,g,b].map(v => v.toString(16).padStart(2,'0')).join('');
}

function createMedalElement(medal, size) {
  size = size || 120;
  const div = document.createElement('div');
  div.className = 'medal-display rarity-' + medal.rarity;
  div.style.width = size + 'px';
  div.style.height = size + 'px';
  const pat = document.createElement('div');
  pat.className = 'medal-pattern';
  pat.style.cssText = renderMedalCSS(medal, size);
  div.appendChild(pat);
  return div;
}

/* ================================================================
   GACHA SYSTEM
   ================================================================ */
function refreshGacha() {
  document.getElementById('gacha-points').textContent = state.points;
  document.getElementById('gacha-btn').disabled = state.points < 1000;
  document.getElementById('gacha-result').classList.remove('show');
  resetCapsule();
}

function resetCapsule() {
  const stage = document.getElementById('gacha-stage');
  stage.classList.remove('spinning', 'opening');
  stage.style.display = 'flex';
  document.getElementById('capsule-top').style.transform = '';
  document.getElementById('capsule-top').style.opacity = '';
}

function pullGacha() {
  if (gachaAnimating || state.points < 1000) return;
  gachaAnimating = true;
  state.points -= 1000;
  saveState();
  document.getElementById('gacha-points').textContent = state.points;
  document.getElementById('gacha-result').classList.remove('show');
  resetCapsule();

  const stage = document.getElementById('gacha-stage');
  stage.style.display = 'flex';
  stage.classList.add('spinning');

  setTimeout(() => {
    stage.classList.remove('spinning');
    stage.classList.add('opening');

    // Determine rarity
    const roll = Math.random() * 100;
    let rarity;
    if (roll < 5) rarity = 'sr';
    else if (roll < 30) rarity = 'rare';
    else rarity = 'normal';

    // Pick medal of that rarity
    const pool = ALL_MEDALS.filter(m => m.rarity === rarity);
    const medal = pool[Math.floor(Math.random() * pool.length)];

    // Flash effect
    if (rarity === 'rare' || rarity === 'sr') {
      const flash = document.getElementById('gacha-flash');
      flash.className = 'gacha-flash show ' + (rarity === 'sr' ? 'sr-flash' : 'rare-flash');
      setTimeout(() => flash.classList.remove('show'), rarity === 'sr' ? 1000 : 600);
    }

    setTimeout(() => {
      stage.style.display = 'none';
      // Check duplicate
      const isNew = !state.medals.includes(medal.id);
      if (isNew) {
        state.medals.push(medal.id);
      } else {
        state.points += 100;
      }
      saveState();
      document.getElementById('gacha-points').textContent = state.points;
      document.getElementById('gacha-btn').disabled = state.points < 1000;

      // Show result
      const resultDiv = document.getElementById('gacha-result');
      const displayDiv = document.getElementById('gacha-medal-display');
      displayDiv.innerHTML = '';
      displayDiv.appendChild(createMedalElement(medal, 120));
      document.getElementById('gacha-medal-name').textContent = medal.name;
      const rarLabel = document.getElementById('gacha-medal-rarity');
      rarLabel.textContent = medal.rarityLabel;
      rarLabel.className = 'medal-rarity-label ' + medal.rarity;
      const badge = document.getElementById('gacha-badge');
      if (isNew) {
        badge.innerHTML = '<div class="new-badge">NEW!</div>';
      } else {
        badge.innerHTML = '<div class="dup-badge">Áç≤ÂæóÊ∏à„Åø +100ptËøîÈÇÑ</div>';
      }
      resultDiv.classList.add('show');
      gachaAnimating = false;
    }, 600);
  }, 900);
}

/* ================================================================
   COLLECTION
   ================================================================ */
function refreshCollection() {
  const owned = state.medals.length;
  document.getElementById('collection-progress').textContent = owned + ' / 100';
  renderCollectionGrid();
}

function renderCollectionGrid() {
  const grid = document.getElementById('collection-grid');
  grid.innerHTML = '';
  const filtered = currentFilter === 'all'
    ? ALL_MEDALS
    : ALL_MEDALS.filter(m => m.rarity === currentFilter);

  filtered.forEach(medal => {
    const owned = state.medals.includes(medal.id);
    const item = document.createElement('div');
    item.className = 'collection-item rarity-' + medal.rarity + (owned ? '' : ' locked');

    const pat = document.createElement('div');
    pat.className = 'medal-pattern';
    pat.style.cssText = renderMedalCSS(medal, 90);
    item.appendChild(pat);

    if (owned) {
      item.onclick = () => showMedalDetail(medal);
    }
    grid.appendChild(item);
  });
}

function filterCollection(filter, btnEl) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');
  renderCollectionGrid();
}

function showMedalDetail(medal) {
  const modal = document.getElementById('medal-modal');
  const displayDiv = document.getElementById('modal-medal-display');
  displayDiv.innerHTML = '';
  displayDiv.appendChild(createMedalElement(medal, 160));
  document.getElementById('modal-medal-name').textContent = medal.name;
  const rarLabel = document.getElementById('modal-medal-rarity');
  rarLabel.textContent = medal.rarityLabel;
  rarLabel.className = 'medal-rarity-label ' + medal.rarity;
  document.getElementById('modal-medal-id').textContent = 'No. ' + (medal.id + 1);
  modal.classList.add('show');
}

function closeMedalModal(e) {
  if (e && e.target !== e.currentTarget && !e.target.classList.contains('modal-close')) return;
  document.getElementById('medal-modal').classList.remove('show');
}

/* ================================================================
   INIT
   ================================================================ */
loadState();
refreshStart();
</script>
</body>
</html>
